<!DOCTYPE html>
<html>
<head>
    <title>ttt</title>
    <meta charset="utf-8"/>
    <style type="text/css">
        body {
            font-family: "Fira", Helvetica, Arial, sans-serif;
            margin: 0;
            text-align: center;
            color: #6b6b6b;
        }
        canvas {
            border: 1px solid #d0d0d0;
            background-color: #fff;
        }
        .everything {
            margin: auto;
        }
    </style>
</head>
<body onload="">
    <canvas id="canvas" ></canvas>

    <script src="scripts/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="scripts/utility.js" type="text/javascript"></script>
    <script src="scripts/movement-processor.js" type="text/javascript"></script>
    <script src="scripts/talking-processor.js" type="text/javascript"></script>
    <script type="text/javascript">

        const KeyProcessingOptionMoving = "moving";
        const KeyProcessingOptionTalking = "talking";



        $(document).ready(function () {

            var model = new TilesModel();
        });

        var WeaponModel = function(name, damage, charge, value) {
            var self = this;

            self.name = name;
            self.damage = damage;
            self.charge = charge;
            self.value = value;

            self.BuyDescription = function() {
                return self.name + "(" + self.damage + " dmg) with " + self.charge + " charge, costs " + self.value + " creds."
            };
        }

        var PersonModel = function(name, initialGreeting, wordTriggers, image, inventory) {
            var self = this;

            self.name = name;
            self.initialGreeting = initialGreeting;
            self.wordTriggers = wordTriggers;
            self.image = image;
            self.buying = false;
            self.inventory = [
                new WeaponModel("Blaster", 5, 20, 5),
                new WeaponModel("Blaster", 5, 17, 4),
            ];

            self.GetInitialGreeting = function() {
                return self.initialGreeting;
            }
            self.StopTalkingTo = function() {
                self.buying = false;
            }
            self.CanTalkTo = function() {
                return self.wordTriggers!==null;
            }
            self.Ask = function(trigger) {
                if(trigger.toLowerCase() === 'buy') {
                    self.buying = true;
                    return self.GetInventory();
                }
                if(!trigger || !self.wordTriggers) return null;
                let triggers = trigger.split(" ");
                for(let t = 0; t < triggers.length; t++) {
                    let wordToTest = triggers[t];
                    for(let i = 0; i < self.wordTriggers.length; i++) {
                        if(self.wordTriggers[i].trigger && self.wordTriggers[i].trigger.toLowerCase().includes(wordToTest.toLowerCase())) {
                            return self.wordTriggers[i].response;
                        }
                    }
                }
            }
            self.GetInventory = function() {
                if(!self.inventory || self.inventory.length === 0) return "I haven't got anything.";
                let output = ["This is what I have:"];
                for(let i = 0; i < self.inventory.length; i++) {
                    output.push(i + " " + self.inventory[i].BuyDescription());
                }
                output.push("What number do you want to buy?");
                return output;
            }
        };

        var TileModel = function(x,y) {
            var self = this;

            self.x = x;
            self.y = y;

            self.image = null;
            self.passable = true;
            self.climbable = false;
            self.person = null;

            self.IsPassable = function() {
                // can't pass if there is a person there
                return self.passable && self.person===null;
            };
            self.IsClimbable = function() {
                // you can climb on people right?
                return self.climbable || self.person;
            };

        };

        var KeyProcessor = function(topLevel) {
            var self = this;

            self.topLevel = topLevel;
            self.keyProcessingChoice = KeyProcessingOptionMoving;


            self.stopTalkingTo = function(person) {
                person.inConversation = false;
                self.keyProcessingChoice = KeyProcessingOptionMoving;
            }

            self.startTalkingTo = function(person) {
                person.inConversation = true;
                self.keyProcessingChoice = KeyProcessingOptionTalking;
                self.talkingProcessor.SetPersonBeingTalkedTo(person);
            }

            self.ProcessKeyPress = function(event) {
                if(self.keyProcessingChoice == KeyProcessingOptionMoving) {
                    self.movementProcessor.ProcessKeyPress(event.key);
                } else if(self.keyProcessingChoice == KeyProcessingOptionTalking) {
                    self.talkingProcessor.ProcessKeyPress(event);
                }
            }

            self.movementProcessor = new MovementProcessor(self.topLevel, this, self.startTalkingTo);
            self.talkingProcessor = new TalkingProcessor(self.topLevel, this, self.stopTalkingTo);
        }

       

        var TilesModel = function() {
            var self = this;

            self.keyProcessor = new KeyProcessor(this);

            self.canvas = document.getElementById('canvas');
            self.ctx = self.canvas.getContext('2d');
            self.loader = null;         // loaded images
            self.images = [];

            self.rows = [];
            self.tileHeight = 40;
            self.tileWidth = 30;
            self.startDrawingX = 0;     // the index of the first tile on the canvas
            self.startDrawingY = 0;     
            self.tilesToDrawFromX = 0;  // how many tiles between the edge and the center
            self.tilesToDrawFromY = 0;
            self.totalTilesInX = 0;     // how many tiles currently on the screen
            self.totalTilesInY = 0;
            self.currentX = 20;         // the tile index position of the user
            self.currentY = 3;
            self.centerTileAtX = 0;     // where to start drawing the center tile (the coordinates on the canvas)
            self.centerTileAtY = 0;
            self.maxX = 1000;
            self.maxY = 1000;


            self.GenerateTiles = function() {
                for(let y = 0; y < self.maxY; y++) {
                    let col = [];

                    for(let x = 0; x < self.maxX; x++) {
                        let tile = new TileModel(x,y);
                        col.push(tile);
                    }
                    self.rows.push(col);
                }
                self.rows[0][0].image = "brick01.png";
                self.rows[0][0].passable = false;
                self.rows[5][19].image = "brick01.png";
                self.rows[5][19].passable = false;
                self.rows[5][19].climbable = true;

                var person1Talkytalky = [
                    { trigger : "test", response: "Yeah, your test worked :)" },
                    { trigger : "second", response: "Your second test is ok" },
                ]
                self.rows[3][15].person = new PersonModel("test person", "howdy partner, you looking to buy?", person1Talkytalky,"person01.png");
            };

            self.GetTileAt = function(tileX,tileY) {
                if(tileX < 0 || tileX >= self.maxX) {
                    return null;
                }
                if(tileY < 0 || tileY >= self.maxY) {
                    return null;
                }
                return self.rows[tileY][tileX];
            }

            self.LoadImages = function(arr, callback) {
                //this.images = {};
                var loadedImageCount = 0;

                // Make sure arr is actually an array and any other error checking
                for (var i = 0; i < arr.length; i++){
                    var img = new Image();
                    img.onload = imageLoaded;
                    img.src = arr[i];
                    let name = arr[i].split("/")[1];
                    self.images[name] = img;
                    //self.images.push(img);
                }

                function imageLoaded(e) {
                    loadedImageCount++;
                    if (loadedImageCount >= arr.length) {
                        callback();
                    }
                }
            };

            

            self.DrawLoop = function() {
                //console.log("starting draw loop")
                self.ctx.fillStyle = 'white';
                self.ctx.fillRect(0, 0, self.canvasWidth, self.canvasHeight);

                // self.ctx.beginPath();
                // self.ctx.strokeStyle = "#ff0000";
                // self.ctx.rect(20, 20, 100, 100);
                // self.ctx.stroke();

                let startDrawingFromTileX = self.currentX - self.tilesToDrawFromX;
                let startDrawingFromTileY = self.currentY - self.tilesToDrawFromY;

                // var img = new Image();
                // img.src = 'images/brick01.png';
                // img.load(function() {
                //     console.log('Image Loaded');
                // });

                self.ctx.save();
                self.ctx.beginPath();
                self.ctx.strokeStyle = "#F2F2F2";
                self.ctx.fillStyle = '#CECECE';
                for(let y = 0; y < self.totalTilesInY; y++) {

                    for(let x = 0; x < self.totalTilesInX; x++) {

                        var drawAtX = self.startDrawingX + (x * self.tileWidth);
                        var drawAtY = self.startDrawingY + (y * self.tileHeight);

                        // draw a rectangle around our tile
                        self.ctx.rect(drawAtX, drawAtY, self.tileWidth, self.tileHeight);

                        // see if we have a tile at this x and y
                        var tileToDraw = self.GetTileAt(startDrawingFromTileX+x,startDrawingFromTileY+y);
                        if(tileToDraw) {
                            // we have a tile to display, so draw what we need to for that tile
                            if(tileToDraw.image) {
                                self.ctx.drawImage(self.images[tileToDraw.image], drawAtX, drawAtY);
                            }
                            // if there is a person on this tile then draw them too
                            if(tileToDraw.person) {
                                self.ctx.drawImage(self.images[tileToDraw.person.image], drawAtX, drawAtY);
                            }
                            // put co-ordinates on the tile
                            self.ctx.textBaseline = "hanging";
                            self.ctx.fillText((startDrawingFromTileX+x)+','+(startDrawingFromTileY+y), drawAtX, drawAtY);
                            
                        } else {
                            // we didn't have a tile, so we're just going to draw an empty rectangle over the tile
                            self.ctx.fillRect(drawAtX, drawAtY, self.tileWidth, self.tileHeight);
                        }
                    }
                }
                self.ctx.stroke();
                self.ctx.restore();

                // draw the player
                self.ctx.drawImage(self.images['person02.png'], self.centerTileAtX, self.centerTileAtY);

                window.requestAnimationFrame(self.DrawLoop);
                //setTimeout(function() { self.DrawLoop() }, 1000);
            };

            self.ResizeHandler = function() {
                console.log("in resize handler");
                self.canvas.width = window.innerWidth - 100;
                self.canvas.height = window.innerHeight - 100;
                self.CalculateDrawSizes();
            }

            self.CalculateDrawSizes = function() {
                // get the map size
                var width = document.getElementById('canvas').offsetWidth;
                var height = document.getElementById('canvas').offsetHeight;
                self.canvasWidth = width;
                self.canvasHeight = height;
                console.log("width by height is " + width + " by " + height);
                // how many tiles wide/high is our canvas?
                var tilesInWidth = Math.ceil(width / self.tileWidth);
                var tilesInHeight = Math.ceil(height / self.tileHeight);
                // where is our start drawing point?
                // and
                // from the center tile, how far back (in tiles) do we start drawing?
                var centerTileAt = (width/2) - (self.tileWidth /2);
                self.centerTileAtX = centerTileAt;
                self.tilesToDrawFromX = Math.ceil(centerTileAt / self.tileWidth);
                self.startDrawingX = centerTileAt - (self.tilesToDrawFromX * self.tileWidth);
                self.totalTilesInX = (self.tilesToDrawFromX * 2) + 1;
                console.log("self.tilesToDrawFromX: " + self.tilesToDrawFromX);
                console.log("self.startDrawingX: " + self.startDrawingX);
                console.log("self.totalTilesInX: " + self.totalTilesInX);

                var centerTileAt = (height/2) - (self.tileHeight /2);
                self.centerTileAtY = centerTileAt;
                self.tilesToDrawFromY = Math.ceil(centerTileAt / self.tileHeight);
                self.startDrawingY = centerTileAt - (self.tilesToDrawFromY * self.tileHeight);
                self.totalTilesInY = (self.tilesToDrawFromY * 2) + 1;
                console.log("self.tilesToDrawFromY: " + self.tilesToDrawFromY);
                console.log("self.startDrawingY: " + self.startDrawingY);
                console.log("self.totalTilesInY: " + self.totalTilesInY);

            };

            self.ProcessKeyDown = function(event) {
                //console.log(event.key);
                self.keyProcessor.ProcessKeyPress(event);
            }

            self.Initialize = function() {
                // get canvas the right size
                self.ResizeHandler();
                // hook up resize handler
                window.addEventListener('resize', self.ResizeHandler, false);
                window.addEventListener('keydown', self.ProcessKeyDown, false);
                // make some dummy tiles
                self.GenerateTiles();
                // figure out how many etc tiles we are drawing
                self.CalculateDrawSizes();
                //window.requestAnimationFrame(self.DrawLoop());
                //self.DrawLoop();
                self.loader = self.LoadImages(['images/brick01.png','images/person01.png','images/person02.png'], function() {
                    //self.DrawLoop();
                    window.requestAnimationFrame(self.DrawLoop);
                });
            };
            self.Initialize();
        };
    </script>
</body>
</html>