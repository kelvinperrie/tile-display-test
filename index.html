<!DOCTYPE html>
<html>
<head>
    <title>ttt</title>
    <meta charset="utf-8"/>
    <style type="text/css">
        body {
            font-family: "Fira", Helvetica, Arial, sans-serif;
            margin: 0;
            text-align: center;
            color: #6b6b6b;
        }
        canvas {
            border: 1px solid #d0d0d0;
            background-color: #fff;
        }
        .everything {
            margin: auto;
        }
    </style>
</head>
<body onload="">
    <canvas id="canvas" ></canvas>

    <script src="jquery-3.3.1.min.js" type="text/javascript"></script>
    <script type="text/javascript">

        function randomIntFromInterval(min, max) { // min and max included 
            return Math.floor(Math.random() * (max - min + 1) + min)
        }

        $(document).ready(function () {

            var model = new TilesModel();
        });

        var TileModel = function(x,y) {
            var self = this;

            self.x = x;
            self.y = y;

            self.image = null;

            // var random = randomIntFromInterval(1,20);
            // if(random == 1) {
            //     self.image = "brick01.png";
            // }
            // else if(random == 2) {
            //     self.image = "pavement02.png";
            // }
            // else {
            //     self.image = "pavement01.png";
            // }
        };

        var TilesModel = function() {
            var self = this;

            self.canvas = document.getElementById('canvas');
            self.ctx = self.canvas.getContext('2d');
            self.loader = null;         // loaded images
            self.images = [];

            self.rows = [];
            self.tileHeight = 40;
            self.tileWidth = 30;
            self.startDrawingY = 0;     // the coordinates on the canvas
            self.startDrawingX = 0;
            self.tilesToDrawFromX = 0;  // how many tiles between the edge and the center
            self.tilesToDrawFromY = 0;
            self.totalTilesInX = 0;
            self.totalTilesInY = 0;
            self.currentX = 20;
            self.currentY = 3;
            self.maxX = 1000;
            self.maxY = 1000;

            self.GenerateTiles = function() {
                for(let y = 0; y < self.maxY; y++) {
                    let col = [];

                    for(let x = 0; x < self.maxX; x++) {
                        let tile = new TileModel(x,y);
                        col.push(tile);
                    }
                    self.rows.push(col);
                }
                self.rows[0][0].image = "brick01.png";
                self.rows[5][19].image = "brick01.png";
            };

            self.GetTileAt = function(tileX,tileY) {
                if(tileX < 0 || tileX >= self.maxX) {
                    return null;
                }
                if(tileY < 0 || tileY >= self.maxY) {
                    return null;
                }
                return self.rows[tileY][tileX];
            }

            self.LoadImages = function(arr, callback) {
                //this.images = {};
                var loadedImageCount = 0;

                // Make sure arr is actually an array and any other error checking
                for (var i = 0; i < arr.length; i++){
                    var img = new Image();
                    img.onload = imageLoaded;
                    img.src = arr[i];
                    //this.images[arr[i]] = img;
                    self.images.push(img);
                }

                function imageLoaded(e) {
                    loadedImageCount++;
                    if (loadedImageCount >= arr.length) {
                        callback();
                    }
                }
            };

            

            self.DrawLoop = function() {
                console.log("starting draw loop")
                self.ctx.fillStyle = 'white';
                self.ctx.fillRect(0, 0, self.canvasWidth, self.canvasHeight);

                // self.ctx.beginPath();
                // self.ctx.strokeStyle = "#ff0000";
                // self.ctx.rect(20, 20, 100, 100);
                // self.ctx.stroke();

                let startDrawingFromTileX = self.currentX - self.tilesToDrawFromX;
                let startDrawingFromTileY = self.currentY - self.tilesToDrawFromY;

                // var img = new Image();
                // img.src = 'images/brick01.png';
                // img.load(function() {
                //     console.log('Image Loaded');
                // });

                self.ctx.save();
                self.ctx.beginPath();
                self.ctx.strokeStyle = "#ff0000";
                self.ctx.fillStyle = 'black';
                for(let y = 0; y < self.totalTilesInY; y++) {
                    //console.log("drawing y of "+y)

                    for(let x = 0; x < self.totalTilesInX; x++) {
                        
                        //console.log("drawing x,y of "+x+","+y);


                        var drawAtX = self.startDrawingX + (x * self.tileWidth);
                        var drawAtY = self.startDrawingY + (y * self.tileHeight);

                        //console.log("x = " + drawAtX + ", y = " + drawAtY)
                        self.ctx.rect(drawAtX, drawAtY, self.tileWidth, self.tileHeight);

                        var tileToDraw = self.GetTileAt(startDrawingFromTileX+x,startDrawingFromTileY+y);
                        if(tileToDraw) {
                            if(tileToDraw.image) {
                                //console.log("drawing image " + tileToDraw.image + " at " + (drawAtX) + "," + (drawAtY))
                                self.ctx.drawImage(self.images[0], drawAtX, drawAtY);
                            }
                            self.ctx.textBaseline = "hanging";
                            self.ctx.fillText((startDrawingFromTileX+x)+','+(startDrawingFromTileY+y), drawAtX, drawAtY);
                            //console.log("got a tile at " + (startDrawingFromTileX+x) + "," + (startDrawingFromTileY+y));
                        } else {
                            //console.log("no tile at " + (startDrawingFromTileX+x) + "," + (startDrawingFromTileY+y));
                            self.ctx.fillRect(drawAtX, drawAtY, self.tileWidth, self.tileHeight);
                        }


                    }
                    
                }
                self.ctx.stroke();
                self.ctx.restore();
                console.log("ended draw loop")

                window.requestAnimationFrame(self.DrawLoop);
                //setTimeout(function() { self.DrawLoop() }, 100);
            };

            self.ResizeHandler = function() {
                console.log("in resize handler");
                self.canvas.width = window.innerWidth - 100;
                self.canvas.height = window.innerHeight - 100;
                self.CalculateDrawSizes();
            }

            self.CalculateDrawSizes = function() {
                // get the map size
                var width = document.getElementById('canvas').offsetWidth;
                var height = document.getElementById('canvas').offsetHeight;
                self.canvasWidth = width;
                self.canvasHeight = height;
                console.log("width by height is " + width + " by " + height);
                // how many tiles wide/high is our canvas?
                var tilesInWidth = Math.ceil(width / self.tileWidth);
                var tilesInHeight = Math.ceil(height / self.tileHeight);
                // where is our start drawing point?
                // and
                // from the center tile, how far back (in tiles) do we start drawing?
                var centerTileAt = (width/2) - (self.tileWidth /2);
                self.tilesToDrawFromX = Math.ceil(centerTileAt / self.tileWidth);
                self.startDrawingX = centerTileAt - (self.tilesToDrawFromX * self.tileWidth);
                self.totalTilesInX = (self.tilesToDrawFromX * 2) + 1;
                console.log("self.tilesToDrawFromX: " + self.tilesToDrawFromX);
                console.log("self.startDrawingX: " + self.startDrawingX);
                console.log("self.totalTilesInX: " + self.totalTilesInX);

                var centerTileAt = (height/2) - (self.tileHeight /2);
                self.tilesToDrawFromY = Math.ceil(centerTileAt / self.tileHeight);
                self.startDrawingY = centerTileAt - (self.tilesToDrawFromY * self.tileHeight);
                self.totalTilesInY = (self.tilesToDrawFromY * 2) + 1;
                console.log("self.tilesToDrawFromY: " + self.tilesToDrawFromY);
                console.log("self.startDrawingY: " + self.startDrawingY);
                console.log("self.totalTilesInY: " + self.totalTilesInY);

            };

            self.Initialize = function() {
                // get canvas the right size
                self.ResizeHandler();
                // hook up resize handler
                window.addEventListener('resize', self.ResizeHandler, false);
                // make some dummy tiles
                self.GenerateTiles();
                // figure out how many etc tiles we are drawing
                self.CalculateDrawSizes();
                //window.requestAnimationFrame(self.DrawLoop());
                //self.DrawLoop();
                self.loader = self.LoadImages(['images/brick01.png'], function() {
                    //self.DrawLoop();
                    window.requestAnimationFrame(self.DrawLoop);
                });
            };
            self.Initialize();
        };
    </script>
</body>
</html>